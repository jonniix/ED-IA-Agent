<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestione Cantieri Edili</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
            --info: #3498db;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --white: #fff;
            --gray: #95a5a6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            background-color: var(--primary);
            color: var(--white);
            padding: 15px 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin-bottom: 30px;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            display: flex;
            align-items: center;
        }

        .logo i {
            margin-right: 10px;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 20px;
        }

        nav ul li a {
            color: var(--white);
            text-decoration: none;
            font-weight: 500;
            padding: 5px 10px;
            border-radius: 4px;
            transition: background-color 0.3s;
        }

        nav ul li a:hover, nav ul li a.active {
            background-color: rgba(255,255,255,0.2);
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 20px;
            margin-bottom: 30px;
        }

        .card {
            background-color: var(--white);
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            padding: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            min-height: 180px;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .card i {
            font-size: 40px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .card h3 {
            margin-bottom: 10px;
            color: var(--primary);
        }

        .card p {
            color: var(--gray);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            background-color: var(--primary);
            color: var(--white);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            text-decoration: none;
            font-size: 16px;
            transition: background-color 0.3s;
            margin: 5px;
        }

        .btn:hover {
            background-color: var(--secondary);
        }

        .btn-success {
            background-color: var(--success);
        }

        .btn-warning {
            background-color: var(--warning);
        }

        .btn-danger {
            background-color: var(--danger);
        }

        .btn-info {
            background-color: var(--info);
        }

        .btn-light {
            background-color: var(--light);
            color: var(--dark);
        }

        .section-title {
            margin-bottom: 20px;
            color: var(--primary);
            font-size: 24px;
            border-bottom: 2px solid var(--primary);
            padding-bottom: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
            background-color: var(--white);
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        th, td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }

        th {
            background-color: var(--primary);
            color: var(--white);
            font-weight: 500;
        }

        tr:hover {
            background-color: #f5f5f5;
        }

        .status {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
            color: var(--white);
        }

        .status-active {
            background-color: var(--success);
        }

        .status-waiting {
            background-color: var(--warning);
        }

        .status-problems {
            background-color: var(--danger);
        }

        .status-completed {
            background-color: var(--info);
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--primary);
        }

        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 16px;
        }

        textarea {
            min-height: 100px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 15px;
        }

        .form-row .form-group {
            flex: 1;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: var(--white);
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 5px 20px rgba(0,0,0,0.2);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .modal-title {
            font-size: 20px;
            color: var(--primary);
        }

        .close {
            font-size: 24px;
            cursor: pointer;
            color: var(--gray);
        }

        .close:hover {
            color: var(--danger);
        }

        .chart-container {
            position: relative;
            height: 300px;
            margin-bottom: 30px;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid #ddd;
            margin-bottom: 20px;
        }

        .tab {
            padding: 10px 20px;
            cursor: pointer;
            border-bottom: 3px solid transparent;
        }

        .tab.active {
            border-bottom: 3px solid var(--primary);
            color: var(--primary);
            font-weight: 500;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 12px;
            font-weight: 500;
            background-color: var(--light);
            color: var(--dark);
        }

        .badge-success {
            background-color: var(--success);
            color: var(--white);
        }

        .badge-warning {
            background-color: var(--warning);
            color: var(--white);
        }

        .badge-danger {
            background-color: var(--danger);
            color: var(--white);
        }

        .badge-info {
            background-color: var(--info);
            color: var(--white);
        }

        .hidden {
            display: none;
        }

        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px 0;
            color: var(--gray);
            font-size: 14px;
            border-top: 1px solid #eee;
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }

            .form-row {
                flex-direction: column;
            }
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <header>
        <div class="container header-content">
            <div class="logo">
                <i class="fas fa-building"></i>
                <span>Gestione Cantieri</span>
            </div>
            <nav>
                <ul>
                    <li><a href="#" class="nav-link active" data-section="home"><i class="fas fa-home"></i> Home</a></li>
                    <li><a href="#" class="nav-link" data-section="cantieri"><i class="fas fa-hard-hat"></i> Cantieri</a></li>
                    <li><a href="#" class="nav-link" data-section="statistiche"><i class="fas fa-chart-bar"></i> Statistiche</a></li>
                    <li><a href="#" class="nav-link" data-section="impostazioni"><i class="fas fa-cog"></i> Impostazioni</a></li>
                    <li><a href="#" class="nav-link" data-section="archivio"><i class="fas fa-archive"></i> Archivio</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <div class="container">
        <!-- Home Section -->
        <section id="home" class="content-section">
            <h2 class="section-title">Dashboard</h2>
            <div class="dashboard">
                <div class="card" data-section="cantieri">
                    <i class="fas fa-hard-hat"></i>
                    <h3>Gestione Cantieri</h3>
                    <p>Visualizza e gestisci tutti i cantieri attivi</p>
                </div>
                <div class="card" data-section="statistiche">
                    <i class="fas fa-chart-pie"></i>
                    <h3>Statistiche</h3>
                    <p>Analisi e grafici dell'andamento aziendale</p>
                </div>
                <div class="card" data-section="impostazioni">
                    <i class="fas fa-cog"></i>
                    <h3>Impostazioni</h3>
                    <p>Configura i parametri aziendali</p>
                </div>
                <div class="card" data-section="archivio">
                    <i class="fas fa-archive"></i>
                    <h3>Archivio Cantieri</h3>
                    <p>Cantieri conclusi e storico lavori</p>
                </div>
            </div>

            <div class="quick-stats">
                <h3 class="section-title">Situazione Attuale</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="active-sites">0</div>
                        <div class="stat-label">Cantieri Attivi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="waiting-sites">0</div>
                        <div class="stat-label">In Attesa</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="completed-sites">0</div>
                        <div class="stat-label">Conclusi</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="problem-sites">0</div>
                        <div class="stat-label">Con Problemi</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Cantieri Section -->
        <section id="cantieri" class="content-section hidden">
            <div class="section-header">
                <h2 class="section-title">Gestione Cantieri</h2>
                <button class="btn btn-success" id="add-cantiere"><i class="fas fa-plus"></i> Nuovo Cantiere</button>
                <button class="btn btn-info" id="export-data"><i class="fas fa-download"></i> Esporta Dati</button>
                <button class="btn btn-light" id="import-data"><i class="fas fa-upload"></i> Importa Dati</button>
                <input type="file" id="file-input" accept=".json" style="display: none;">
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="active">Attivi</div>
                <div class="tab" data-tab="waiting">In Attesa</div>
                <div class="tab" data-tab="completed">Conclusi</div>
                <div class="tab" data-tab="problems">Problemi</div>
            </div>

            <div class="tab-content active" data-tab-content="active">
                <table id="active-cantieri-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cliente</th>
                            <th>Indirizzo</th>
                            <th>Inizio</th>
                            <th>Fine Prevista</th>
                            <th>Budget</th>
                            <th>Spesa</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" data-tab-content="waiting">
                <table id="waiting-cantieri-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cliente</th>
                            <th>Indirizzo</th>
                            <th>Inizio Previsto</th>
                            <th>Durata Stimata</th>
                            <th>Budget</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" data-tab-content="completed">
                <table id="completed-cantieri-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cliente</th>
                            <th>Indirizzo</th>
                            <th>Periodo</th>
                            <th>Budget</th>
                            <th>Costo Finale</th>
                            <th>Margine</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" data-tab-content="problems">
                <table id="problems-cantieri-table">
                    <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Cliente</th>
                            <th>Indirizzo</th>
                            <th>Periodo</th>
                            <th>Budget</th>
                            <th>Costo Finale</th>
                            <th>Problema</th>
                            <th>Stato</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody>
                        <!-- Popolato dinamicamente -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- Statistiche Section -->
        <section id="statistiche" class="content-section hidden">
            <h2 class="section-title">Statistiche e Analisi</h2>
            
            <div class="tabs">
                <div class="tab active" data-tab="financial">Finanziarie</div>
                <div class="tab" data-tab="performance">Prestazioni</div>
                <div class="tab" data-tab="materials">Materiali</div>
            </div>

            <div class="tab-content active" data-tab-content="financial">
                <div class="chart-container">
                    <canvas id="financial-chart"></canvas>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-revenue">CHF 0</div>
                        <div class="stat-label">Fatturato Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-cost">CHF 0</div>
                        <div class="stat-label">Costi Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="total-profit">CHF 0</div>
                        <div class="stat-label">Profitto Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="profit-margin">0%</div>
                        <div class="stat-label">Margine di Profitto</div>
                    </div>
                </div>
            </div>

            <div class="tab-content" data-tab-content="performance">
                <div class="chart-container">
                    <canvas id="performance-chart"></canvas>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-hours">0</div>
                        <div class="stat-label">Ore Totali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="avg-duration">0 giorni</div>
                        <div class="stat-label">Durata Media</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="on-time">0%</div>
                        <div class="stat-label">Consegne in Tempo</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="efficiency">0%</div>
                        <div class="stat-label">Efficienza</div>
                    </div>
                </div>
            </div>

            <div class="tab-content" data-tab-content="materials">
                <div class="chart-container">
                    <canvas id="materials-chart"></canvas>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="total-materials">CHF 0</div>
                        <div class="stat-label">Spesa Materiali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="materials-percentage">0%</div>
                        <div class="stat-label">% sul Totale</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="materials-markup">CHF 0</div>
                        <div class="stat-label">Margine Materiali</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="top-material">-</div>
                        <div class="stat-label">Materiale più Usato</div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Impostazioni Section -->
        <section id="impostazioni" class="content-section hidden">
            <h2 class="section-title">Impostazioni Aziendali</h2>
            
            <form id="company-settings">
                <div class="form-row">
                    <div class="form-group">
                        <label for="company-name">Nome Azienda</label>
                        <input type="text" id="company-name" required>
                    </div>
                    <div class="form-group">
                        <label for="company-address">Indirizzo</label>
                        <input type="text" id="company-address" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="annual-revenue">Fatturato Annuo Stimato (CHF)</label>
                        <input type="number" id="annual-revenue" step="1000" required>
                    </div>
                    <div class="form-group">
                        <label for="fixed-costs">Costi Fissi Annui (CHF)</label>
                        <input type="number" id="fixed-costs" step="1000" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="worker-hourly-cost">Costo Orario Operaio (CHF)</label>
                        <input type="number" id="worker-hourly-cost" step="0.5" required>
                    </div>
                    <div class="form-group">
                        <label for="foreman-hourly-cost">Costo Orario Capocantiere (CHF)</label>
                        <input type="number" id="foreman-hourly-cost" step="0.5" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="material-markup">Ricarico % Materiali</label>
                        <input type="number" id="material-markup" step="1" required>
                    </div>
                    <div class="form-group">
                        <label for="vat-rate">Aliquota IVA (%)</label>
                        <input type="number" id="vat-rate" step="0.1" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="company-notes">Note Aziendali</label>
                    <textarea id="company-notes"></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">Salva Impostazioni</button>
            </form>
        </section>

        <!-- Archivio Section -->
        <section id="archivio" class="content-section hidden">
            <h2 class="section-title">Archivio Cantieri</h2>
            
            <div class="filters">
                <div class="form-row">
                    <div class="form-group">
                        <label for="archive-year">Anno</label>
                        <select id="archive-year">
                            <option value="all">Tutti</option>
                            <!-- Popolato dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="archive-client">Cliente</label>
                        <select id="archive-client">
                            <option value="all">Tutti</option>
                            <!-- Popolato dinamicamente -->
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="archive-status">Stato</label>
                        <select id="archive-status">
                            <option value="all">Tutti</option>
                            <option value="completed">Conclusi</option>
                            <option value="problems">Con Problemi</option>
                            <option value="canceled">Annullati</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn btn-info" id="apply-filters">Applica Filtri</button>
                    </div>
                </div>
            </div>
            
            <table id="archive-table">
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Cliente</th>
                        <th>Indirizzo</th>
                        <th>Anno</th>
                        <th>Budget</th>
                        <th>Costo Finale</th>
                        <th>Margine</th>
                        <th>Stato</th>
                        <th>Azioni</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Popolato dinamicamente -->
                </tbody>
            </table>
        </section>
    </div>

    <!-- Cantiere Modal -->
    <div id="cantiere-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nuovo Cantiere</h3>
                <span class="close">&times;</span>
            </div>
            <form id="cantiere-form">
                <input type="hidden" id="cantiere-id">
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cantiere-name">Nome Cantiere*</label>
                        <input type="text" id="cantiere-name" required>
                    </div>
                    <div class="form-group">
                        <label for="cantiere-client">Cliente*</label>
                        <input type="text" id="cantiere-client" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cantiere-address">Indirizzo*</label>
                        <input type="text" id="cantiere-address" required>
                    </div>
                    <div class="form-group">
                        <label for="cantiere-city">Città*</label>
                        <input type="text" id="cantiere-city" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cantiere-start">Data Inizio*</label>
                        <input type="date" id="cantiere-start" required>
                    </div>
                    <div class="form-group">
                        <label for="cantiere-end">Data Fine Prevista*</label>
                        <input type="date" id="cantiere-end" required>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="cantiere-budget">Budget (CHF)*</label>
                        <input type="number" id="cantiere-budget" step="100" required>
                    </div>
                    <div class="form-group">
                        <label for="cantiere-status">Stato*</label>
                        <select id="cantiere-status" required>
                            <option value="active">Attivo</option>
                            <option value="waiting">In Attesa</option>
                            <option value="completed">Concluso</option>
                            <option value="problems">Problemi</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="cantiere-description">Descrizione</label>
                    <textarea id="cantiere-description"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="cantiere-notes">Note</label>
                    <textarea id="cantiere-notes"></textarea>
                </div>
                
                <button type="submit" class="btn btn-success">Salva Cantiere</button>
            </form>
        </div>
    </div>

    <!-- Dettaglio Cantiere Modal -->
    <div id="detail-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Dettaglio Cantiere</h3>
                <span class="close">&times;</span>
            </div>
            <div class="modal-body">
                <div class="tabs">
                    <div class="tab active" data-tab="info">Informazioni</div>
                    <div class="tab" data-tab="costs">Costi</div>
                    <div class="tab" data-tab="materials">Materiali</div>
                    <div class="tab" data-tab="workers">Personale</div>
                </div>
                
                <div class="tab-content active" data-tab-content="info">
                    <div class="info-header">
                        <h4 id="detail-name"></h4>
                        <p id="detail-client"></p>
                        <p id="detail-address"></p>
                        <p id="detail-period"></p>
                        <div class="status-badge" id="detail-status"></div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="detail-chart"></canvas>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="detail-budget">CHF 0</div>
                            <div class="stat-label">Budget</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="detail-spent">CHF 0</div>
                            <div class="stat-label">Speso</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="detail-remaining">CHF 0</div>
                            <div class="stat-label">Residuo</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="detail-margin">0%</div>
                            <div class="stat-label">Margine</div>
                        </div>
                    </div>
                    
                    <div class="info-description">
                        <h5>Descrizione</h5>
                        <p id="detail-description"></p>
                    </div>
                    
                    <div class="info-notes">
                        <h5>Note</h5>
                        <p id="detail-notes"></p>
                    </div>
                </div>
                
                <div class="tab-content" data-tab-content="costs">
                    <h4>Registra Nuovo Costo</h4>
                    <form id="cost-form">
                        <input type="hidden" id="cost-cantiere-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cost-date">Data*</label>
                                <input type="date" id="cost-date" required>
                            </div>
                            <div class="form-group">
                                <label for="cost-type">Tipo*</label>
                                <select id="cost-type" required>
                                    <option value="labor">Mano d'opera</option>
                                    <option value="material">Materiale</option>
                                    <option value="equipment">Attrezzatura</option>
                                    <option value="other">Altro</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="cost-amount">Importo (CHF)*</label>
                                <input type="number" id="cost-amount" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="cost-category">Categoria</label>
                                <input type="text" id="cost-category">
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="cost-description">Descrizione</label>
                            <textarea id="cost-description"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">Aggiungi Costo</button>
                    </form>
                    
                    <h4 style="margin-top: 30px;">Storico Costi</h4>
                    <table id="costs-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Tipo</th>
                                <th>Descrizione</th>
                                <th>Importo (CHF)</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-content" data-tab-content="materials">
                    <h4>Registra Nuovo Materiale</h4>
                    <form id="material-form">
                        <input type="hidden" id="material-cantiere-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="material-date">Data*</label>
                                <input type="date" id="material-date" required>
                            </div>
                            <div class="form-group">
                                <label for="material-name">Materiale*</label>
                                <input type="text" id="material-name" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="material-quantity">Quantità*</label>
                                <input type="number" id="material-quantity" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="material-unit">Unità di misura*</label>
                                <select id="material-unit" required>
                                    <option value="kg">kg</option>
                                    <option value="m">m</option>
                                    <option value="m2">m²</option>
                                    <option value="m3">m³</option>
                                    <option value="l">l</option>
                                    <option value="pz">pz</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="material-unit-cost">Costo Unitario (CHF)*</label>
                                <input type="number" id="material-unit-cost" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="material-total-cost">Costo Totale (CHF)</label>
                                <input type="number" id="material-total-cost" step="0.01" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="material-supplier">Fornitore</label>
                            <input type="text" id="material-supplier">
                        </div>
                        
                        <div class="form-group">
                            <label for="material-notes">Note</label>
                            <textarea id="material-notes"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">Aggiungi Materiale</button>
                    </form>
                    
                    <h4 style="margin-top: 30px;">Materiali Utilizzati</h4>
                    <table id="materials-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Materiale</th>
                                <th>Quantità</th>
                                <th>Costo Unitario</th>
                                <th>Costo Totale</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
                
                <div class="tab-content" data-tab-content="workers">
                    <h4>Registra Ore Lavoro</h4>
                    <form id="worker-form">
                        <input type="hidden" id="worker-cantiere-id">
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="worker-date">Data*</label>
                                <input type="date" id="worker-date" required>
                            </div>
                            <div class="form-group">
                                <label for="worker-name">Nome*</label>
                                <input type="text" id="worker-name" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="worker-role">Ruolo*</label>
                                <select id="worker-role" required>
                                    <option value="worker">Operaio</option>
                                    <option value="foreman">Capocantiere</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="worker-hours">Ore*</label>
                                <input type="number" id="worker-hours" step="0.5" min="0.5" max="12" required>
                            </div>
                        </div>
                        
                        <div class="form-row">
                            <div class="form-group">
                                <label for="worker-hourly-cost">Costo Orario (CHF)</label>
                                <input type="number" id="worker-hourly-cost" step="0.5" readonly>
                            </div>
                            <div class="form-group">
                                <label for="worker-total-cost">Costo Totale (CHF)</label>
                                <input type="number" id="worker-total-cost" step="0.01" readonly>
                            </div>
                        </div>
                        
                        <div class="form-group">
                            <label for="worker-notes">Note</label>
                            <textarea id="worker-notes"></textarea>
                        </div>
                        
                        <button type="submit" class="btn btn-success">Aggiungi Ore</button>
                    </form>
                    
                    <h4 style="margin-top: 30px;">Ore Lavorative</h4>
                    <table id="workers-table">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Nome</th>
                                <th>Ruolo</th>
                                <th>Ore</th>
                                <th>Costo Orario</th>
                                <th>Costo Totale</th>
                                <th>Azioni</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- Popolato dinamicamente -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="container">
            <p>Gestione Cantieri Edili &copy; <span id="current-year"></span> - Tutti i diritti riservati</p>
            <p>Applicazione offline - Dati salvati localmente</p>
        </div>
    </footer>

    <script>
        // Dati dell'applicazione
        let appData = {
            settings: {
                companyName: "Edilizia SA",
                companyAddress: "Via Cantonale 12, 6900 Lugano",
                annualRevenue: 1500000,
                fixedCosts: 500000,
                workerHourlyCost: 35,
                foremanHourlyCost: 50,
                materialMarkup: 20,
                vatRate: 7.7
            },
            cantieri: [],
            archive: []
        };

        // Stato dell'applicazione
        let currentState = {
            activeSection: "home",
            activeCantiereTab: "active",
            activeStatsTab: "financial",
            activeDetailTab: "info",
            selectedCantiere: null
        };

        // Inizializzazione
        document.addEventListener('DOMContentLoaded', function() {
            // Carica i dati salvati
            loadData();
            
            // Imposta l'anno corrente nel footer
            document.getElementById('current-year').textContent = new Date().getFullYear();
            
            // Gestione navigazione
            setupNavigation();
            
            // Gestione tabs
            setupTabs();
            
            // Gestione modali
            setupModals();
            
            // Gestione form
            setupForms();
            
            // Aggiorna la UI
            updateUI();
            
            // Aggiorna le statistiche
            updateStats();
            
            // Aggiorna i cantieri
            updateCantieriTables();
            
            // Aggiorna l'archivio
            updateArchive();
        });

        // Funzioni di utilità
        function formatCHF(amount) {
            return `CHF ${amount.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, "'")}`;
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleDateString('it-CH');
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'active': return '<span class="status status-active">🟢 Attivo</span>';
                case 'waiting': return '<span class="status status-waiting">🟡 In Attesa</span>';
                case 'completed': return '<span class="status status-completed">🔵 Concluso</span>';
                case 'problems': return '<span class="status status-problems">🔴 Problemi</span>';
                default: return '<span class="status">' + status + '</span>';
            }
        }

        // Gestione dati
        function saveData() {
            localStorage.setItem('ediliziaAppData', JSON.stringify(appData));
        }

        function loadData() {
            const savedData = localStorage.getItem('ediliziaAppData');
            if (savedData) {
                appData = JSON.parse(savedData);
            }
        }

        function exportData() {
            const dataStr = JSON.stringify(appData, null, 2);
            const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
            
            const exportFileDefaultName = `backup-cantieri-${new Date().toISOString().split('T')[0]}.json`;
            
            const linkElement = document.createElement('a');
            linkElement.setAttribute('href', dataUri);
            linkElement.setAttribute('download', exportFileDefaultName);
            linkElement.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const importedData = JSON.parse(e.target.result);
                    appData = importedData;
                    saveData();
                    updateUI();
                    updateStats();
                    updateCantieriTables();
                    updateArchive();
                    alert('Dati importati con successo!');
                } catch (error) {
                    alert('Errore durante l\'importazione dei dati: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // Gestione UI
        function setupNavigation() {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
            
            document.querySelectorAll('.card[data-section]').forEach(card => {
                card.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });
        }

        function showSection(section) {
            // Nascondi tutte le sezioni
            document.querySelectorAll('.content-section').forEach(sec => {
                sec.classList.add('hidden');
            });
            
            // Mostra la sezione richiesta
            document.getElementById(section).classList.remove('hidden');
            
            // Aggiorna la navigazione
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.getAttribute('data-section') === section) {
                    link.classList.add('active');
                }
            });
            
            // Salva lo stato
            currentState.activeSection = section;
            
            // Aggiornamenti specifici per sezione
            if (section === 'cantieri') {
                updateCantieriTables();
            } else if (section === 'statistiche') {
                updateCharts();
            } else if (section === 'impostazioni') {
                loadSettingsForm();
            } else if (section === 'archivio') {
                updateArchive();
            }
        }

        function setupTabs() {
            // Tabs cantieri
            document.querySelectorAll('.tabs[data-tab-group="cantieri"] .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Aggiorna tabs attivi
                    this.parentNode.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Aggiorna contenuti
                    this.closest('.tab-container').querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.getAttribute('data-tab-content') === tabId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Salva lo stato
                    currentState.activeCantiereTab = tabId;
                });
            });
            
            // Tabs statistiche
            document.querySelectorAll('.tabs[data-tab-group="statistiche"] .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Aggiorna tabs attivi
                    this.parentNode.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Aggiorna contenuti
                    this.closest('.tab-container').querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.getAttribute('data-tab-content') === tabId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Salva lo stato
                    currentState.activeStatsTab = tabId;
                    
                    // Aggiorna i grafici
                    updateCharts();
                });
            });
            
            // Tabs dettaglio cantiere
            document.querySelectorAll('.tabs[data-tab-group="detail"] .tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // Aggiorna tabs attivi
                    this.parentNode.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    
                    // Aggiorna contenuti
                    this.closest('.tab-container').querySelectorAll('.tab-content').forEach(content => {
                        content.classList.remove('active');
                        if (content.getAttribute('data-tab-content') === tabId) {
                            content.classList.add('active');
                        }
                    });
                    
                    // Salva lo stato
                    currentState.activeDetailTab = tabId;
                });
            });
        }

        function setupModals() {
            // Modal nuovo cantiere
            const cantiereModal = document.getElementById('cantiere-modal');
            const addCantiereBtn = document.getElementById('add-cantiere');
            const closeCantiereModal = cantiereModal.querySelector('.close');
            
            addCantiereBtn.addEventListener('click', function() {
                document.getElementById('cantiere-id').value = '';
                document.getElementById('cantiere-form').reset();
                cantiereModal.style.display = 'flex';
            });
            
            closeCantiereModal.addEventListener('click', function() {
                cantiereModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === cantiereModal) {
                    cantiereModal.style.display = 'none';
                }
            });
            
            // Modal dettaglio cantiere
            const detailModal = document.getElementById('detail-modal');
            const closeDetailModal = detailModal.querySelector('.close');
            
            closeDetailModal.addEventListener('click', function() {
                detailModal.style.display = 'none';
            });
            
            window.addEventListener('click', function(event) {
                if (event.target === detailModal) {
                    detailModal.style.display = 'none';
                }
            });
            
            // Import/export
            const exportBtn = document.getElementById('export-data');
            const importBtn = document.getElementById('import-data');
            const fileInput = document.getElementById('file-input');
            
            exportBtn.addEventListener('click', exportData);
            importBtn.addEventListener('click', function() {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', importData);
        }

        function setupForms() {
            // Form impostazioni
            document.getElementById('company-settings').addEventListener('submit', function(e) {
                e.preventDefault();
                saveSettings();
            });
            
            // Form cantiere
            document.getElementById('cantiere-form').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCantiere();
            });
            
            // Form costi
            document.getElementById('cost-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addCost();
            });
            
            // Form materiali
            document.getElementById('material-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addMaterial();
            });
            
            // Calcolo automatico costo totale materiali
            document.getElementById('material-quantity').addEventListener('input', calculateMaterialTotal);
            document.getElementById('material-unit-cost').addEventListener('input', calculateMaterialTotal);
            
            // Form lavoratori
            document.getElementById('worker-form').addEventListener('submit', function(e) {
                e.preventDefault();
                addWorker();
            });
            
            // Calcolo automatico costo lavoratori
            document.getElementById('worker-hours').addEventListener('input', calculateWorkerTotal);
            document.getElementById('worker-role').addEventListener('change', function() {
                const role = this.value;
                const hourlyCost = role === 'worker' ? appData.settings.workerHourlyCost : appData.settings.foremanHourlyCost;
                document.getElementById('worker-hourly-cost').value = hourlyCost;
                calculateWorkerTotal();
            });
            
            // Filtri archivio
            document.getElementById('apply-filters').addEventListener('click', updateArchive);
        }

        function calculateMaterialTotal() {
            const quantity = parseFloat(document.getElementById('material-quantity').value) || 0;
            const unitCost = parseFloat(document.getElementById('material-unit-cost').value) || 0;
            const totalCost = quantity * unitCost;
            document.getElementById('material-total-cost').value = totalCost.toFixed(2);
        }

        function calculateWorkerTotal() {
            const hours = parseFloat(document.getElementById('worker-hours').value) || 0;
            const hourlyCost = parseFloat(document.getElementById('worker-hourly-cost').value) || 0;
            const totalCost = hours * hourlyCost;
            document.getElementById('worker-total-cost').value = totalCost.toFixed(2);
        }

        // Gestione cantieri
        function updateCantieriTables() {
            updateCantieriTable('active');
            updateCantieriTable('waiting');
            updateCantieriTable('completed');
            updateCantieriTable('problems');
            
            // Aggiorna contatori dashboard
            updateDashboardCounters();
        }

        function updateCantieriTable(status) {
            const tableId = `${status}-cantieri-table`;
            const tbody = document.querySelector(`#${tableId} tbody`);
            tbody.innerHTML = '';
            
            const cantieri = appData.cantieri.filter(c => c.status === status);
            
            cantieri.forEach(cantiere => {
                const row = document.createElement('tr');
                
                // Calcola spesa totale
                const totalSpent = calculateTotalSpent(cantiere);
                
                // Formatta le date
                const startDate = formatDate(cantiere.startDate);
                const endDate = cantiere.endDate ? formatDate(cantiere.endDate) : '-';
                
                // Crea le celle
                const nameCell = document.createElement('td');
                nameCell.textContent = cantiere.name;
                
                const clientCell = document.createElement('td');
                clientCell.textContent = cantiere.client;
                
                const addressCell = document.createElement('td');
                addressCell.textContent = `${cantiere.address}, ${cantiere.city}`;
                
                const startCell = document.createElement('td');
                startCell.textContent = startDate;
                
                const endCell = document.createElement('td');
                endCell.textContent = endDate;
                
                const budgetCell = document.createElement('td');
                budgetCell.textContent = formatCHF(cantiere.budget);
                
                const spentCell = document.createElement('td');
                spentCell.textContent = formatCHF(totalSpent);
                
                const statusCell = document.createElement('td');
                statusCell.innerHTML = getStatusBadge(cantiere.status);
                
                const actionsCell = document.createElement('td');
                
                const viewBtn = document.createElement('button');
                viewBtn.className = 'btn btn-info';
                viewBtn.innerHTML = '<i class="fas fa-eye"></i>';
                viewBtn.title = 'Visualizza';
                viewBtn.addEventListener('click', () => showCantiereDetail(cantiere.id));
                
                const editBtn = document.createElement('button');
                editBtn.className = 'btn btn-warning';
                editBtn.innerHTML = '<i class="fas fa-edit"></i>';
                editBtn.title = 'Modifica';
                editBtn.addEventListener('click', () => editCantiere(cantiere.id));
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Elimina';
                deleteBtn.addEventListener('click', () => deleteCantiere(cantiere.id));
                
                actionsCell.appendChild(viewBtn);
                actionsCell.appendChild(editBtn);
                actionsCell.appendChild(deleteBtn);
                
                // Aggiungi le celle alla riga
                row.appendChild(nameCell);
                row.appendChild(clientCell);
                row.appendChild(addressCell);
                row.appendChild(startCell);
                row.appendChild(endCell);
                row.appendChild(budgetCell);
                
                if (status === 'active' || status === 'problems') {
                    row.appendChild(spentCell);
                }
                
                if (status === 'completed') {
                    const margin = cantiere.budget - totalSpent;
                    const marginCell = document.createElement('td');
                    marginCell.textContent = formatCHF(margin);
                    row.appendChild(marginCell);
                }
                
                row.appendChild(statusCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        function calculateTotalSpent(cantiere) {
            let total = 0;
            
            // Costi diretti
            if (cantiere.costs) {
                total += cantiere.costs.reduce((sum, cost) => sum + cost.amount, 0);
            }
            
            // Materiali
            if (cantiere.materials) {
                total += cantiere.materials.reduce((sum, material) => sum + (material.quantity * material.unitCost), 0);
            }
            
            // Lavoratori
            if (cantiere.workers) {
                total += cantiere.workers.reduce((sum, worker) => sum + (worker.hours * worker.hourlyCost), 0);
            }
            
            return total;
        }

        function showCantiereDetail(cantiereId) {
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere) return;
            
            currentState.selectedCantiere = cantiereId;
            
            // Popola le info generali
            document.getElementById('detail-name').textContent = cantiere.name;
            document.getElementById('detail-client').textContent = `Cliente: ${cantiere.client}`;
            document.getElementById('detail-address').textContent = `Indirizzo: ${cantiere.address}, ${cantiere.city}`;
            document.getElementById('detail-period').textContent = `Periodo: ${formatDate(cantiere.startDate)} - ${cantiere.endDate ? formatDate(cantiere.endDate) : 'in corso'}`;
            document.getElementById('detail-status').innerHTML = getStatusBadge(cantiere.status);
            document.getElementById('detail-description').textContent = cantiere.description || 'Nessuna descrizione fornita';
            document.getElementById('detail-notes').textContent = cantiere.notes || 'Nessuna nota';
            
            // Calcola i totali
            const totalSpent = calculateTotalSpent(cantiere);
            const remaining = cantiere.budget - totalSpent;
            const margin = ((cantiere.budget - totalSpent) / cantiere.budget * 100).toFixed(1);
            
            // Aggiorna i valori
            document.getElementById('detail-budget').textContent = formatCHF(cantiere.budget);
            document.getElementById('detail-spent').textContent = formatCHF(totalSpent);
            document.getElementById('detail-remaining').textContent = formatCHF(remaining);
            document.getElementById('detail-margin').textContent = `${margin}%`;
            
            // Imposta l'ID del cantiere nei form
            document.getElementById('cost-cantiere-id').value = cantiereId;
            document.getElementById('material-cantiere-id').value = cantiereId;
            document.getElementById('worker-cantiere-id').value = cantiereId;
            
            // Aggiorna le tabelle
            updateCostsTable(cantiere);
            updateMaterialsTable(cantiere);
            updateWorkersTable(cantiere);
            
            // Mostra il modal
            document.getElementById('detail-modal').style.display = 'flex';
            
            // Aggiorna il grafico
            updateDetailChart(cantiere);
        }

        function updateDetailChart(cantiere) {
            const ctx = document.getElementById('detail-chart').getContext('2d');
            
            // Se esiste già un grafico, distruggilo
            if (window.detailChart) {
                window.detailChart.destroy();
            }
            
            const totalSpent = calculateTotalSpent(cantiere);
            const remaining = Math.max(0, cantiere.budget - totalSpent);
            
            window.detailChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Speso', 'Residuo'],
                    datasets: [{
                        data: [totalSpent, remaining],
                        backgroundColor: [
                            '#e74c3c',
                            '#27ae60'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.label || '';
                                    const value = context.raw || 0;
                                    const percentage = context.dataset.data.reduce((a, b) => a + b, 0) > 0 ? 
                                        Math.round((value / context.dataset.data.reduce((a, b) => a + b, 0)) * 100) : 0;
                                    return `${label}: ${formatCHF(value)} (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        function updateCostsTable(cantiere) {
            const tbody = document.querySelector('#costs-table tbody');
            tbody.innerHTML = '';
            
            if (!cantiere.costs || cantiere.costs.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 5;
                cell.textContent = 'Nessun costo registrato';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            
            cantiere.costs.forEach((cost, index) => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(cost.date);
                
                const typeCell = document.createElement('td');
                typeCell.textContent = cost.type === 'labor' ? 'Mano d\'opera' : 
                                      cost.type === 'material' ? 'Materiale' : 
                                      cost.type === 'equipment' ? 'Attrezzatura' : 'Altro';
                
                const descCell = document.createElement('td');
                descCell.textContent = cost.description || '-';
                
                const amountCell = document.createElement('td');
                amountCell.textContent = formatCHF(cost.amount);
                
                const actionsCell = document.createElement('td');
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Elimina';
                deleteBtn.addEventListener('click', () => deleteCost(cantiere.id, index));
                
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(dateCell);
                row.appendChild(typeCell);
                row.appendChild(descCell);
                row.appendChild(amountCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        function updateMaterialsTable(cantiere) {
            const tbody = document.querySelector('#materials-table tbody');
            tbody.innerHTML = '';
            
            if (!cantiere.materials || cantiere.materials.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 6;
                cell.textContent = 'Nessun materiale registrato';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            
            cantiere.materials.forEach((material, index) => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(material.date);
                
                const nameCell = document.createElement('td');
                nameCell.textContent = material.name;
                
                const quantityCell = document.createElement('td');
                quantityCell.textContent = `${material.quantity} ${material.unit}`;
                
                const unitCostCell = document.createElement('td');
                unitCostCell.textContent = formatCHF(material.unitCost);
                
                const totalCostCell = document.createElement('td');
                totalCostCell.textContent = formatCHF(material.quantity * material.unitCost);
                
                const actionsCell = document.createElement('td');
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Elimina';
                deleteBtn.addEventListener('click', () => deleteMaterial(cantiere.id, index));
                
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(dateCell);
                row.appendChild(nameCell);
                row.appendChild(quantityCell);
                row.appendChild(unitCostCell);
                row.appendChild(totalCostCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        function updateWorkersTable(cantiere) {
            const tbody = document.querySelector('#workers-table tbody');
            tbody.innerHTML = '';
            
            if (!cantiere.workers || cantiere.workers.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 7;
                cell.textContent = 'Nessuna ora lavorativa registrata';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }
            
            cantiere.workers.forEach((worker, index) => {
                const row = document.createElement('tr');
                
                const dateCell = document.createElement('td');
                dateCell.textContent = formatDate(worker.date);
                
                const nameCell = document.createElement('td');
                nameCell.textContent = worker.name;
                
                const roleCell = document.createElement('td');
                roleCell.textContent = worker.role === 'worker' ? 'Operaio' : 'Capocantiere';
                
                const hoursCell = document.createElement('td');
                hoursCell.textContent = worker.hours;
                
                const hourlyCostCell = document.createElement('td');
                hourlyCostCell.textContent = formatCHF(worker.hourlyCost);
                
                const totalCostCell = document.createElement('td');
                totalCostCell.textContent = formatCHF(worker.hours * worker.hourlyCost);
                
                const actionsCell = document.createElement('td');
                
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-danger btn-sm';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.title = 'Elimina';
                deleteBtn.addEventListener('click', () => deleteWorker(cantiere.id, index));
                
                actionsCell.appendChild(deleteBtn);
                
                row.appendChild(dateCell);
                row.appendChild(nameCell);
                row.appendChild(roleCell);
                row.appendChild(hoursCell);
                row.appendChild(hourlyCostCell);
                row.appendChild(totalCostCell);
                row.appendChild(actionsCell);
                
                tbody.appendChild(row);
            });
        }

        function editCantiere(cantiereId) {
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere) return;
            
            document.getElementById('cantiere-id').value = cantiere.id;
            document.getElementById('cantiere-name').value = cantiere.name;
            document.getElementById('cantiere-client').value = cantiere.client;
            document.getElementById('cantiere-address').value = cantiere.address;
            document.getElementById('cantiere-city').value = cantiere.city;
            document.getElementById('cantiere-start').value = cantiere.startDate;
            document.getElementById('cantiere-end').value = cantiere.endDate || '';
            document.getElementById('cantiere-budget').value = cantiere.budget;
            document.getElementById('cantiere-status').value = cantiere.status;
            document.getElementById('cantiere-description').value = cantiere.description || '';
            document.getElementById('cantiere-notes').value = cantiere.notes || '';
            
            document.getElementById('cantiere-modal').style.display = 'flex';
        }

        function saveCantiere() {
            const id = document.getElementById('cantiere-id').value;
            const name = document.getElementById('cantiere-name').value;
            const client = document.getElementById('cantiere-client').value;
            const address = document.getElementById('cantiere-address').value;
            const city = document.getElementById('cantiere-city').value;
            const startDate = document.getElementById('cantiere-start').value;
            const endDate = document.getElementById('cantiere-end').value;
            const budget = parseFloat(document.getElementById('cantiere-budget').value);
            const status = document.getElementById('cantiere-status').value;
            const description = document.getElementById('cantiere-description').value;
            const notes = document.getElementById('cantiere-notes').value;
            
            if (id) {
                // Modifica cantiere esistente
                const index = appData.cantieri.findIndex(c => c.id === id);
                if (index !== -1) {
                    appData.cantieri[index] = {
                        ...appData.cantieri[index],
                        name,
                        client,
                        address,
                        city,
                        startDate,
                        endDate,
                        budget,
                        status,
                        description,
                        notes
                    };
                }
            } else {
                // Nuovo cantiere
                const newCantiere = {
                    id: Date.now().toString(),
                    name,
                    client,
                    address,
                    city,
                    startDate,
                    endDate,
                    budget,
                    status,
                    description,
                    notes,
                    costs: [],
                    materials: [],
                    workers: []
                };
                
                appData.cantieri.push(newCantiere);
            }
            
            saveData();
            updateCantieriTables();
            document.getElementById('cantiere-modal').style.display = 'none';
        }

        function deleteCantiere(cantiereId) {
            if (confirm('Sei sicuro di voler eliminare questo cantiere?')) {
                const index = appData.cantieri.findIndex(c => c.id === cantiereId);
                if (index !== -1) {
                    const deletedCantiere = appData.cantieri.splice(index, 1)[0];
                    
                    // Aggiungi all'archivio
                    appData.archive.push({
                        ...deletedCantiere,
                        archivedAt: new Date().toISOString()
                    });
                    
                    saveData();
                    updateCantieriTables();
                    updateArchive();
                }
            }
        }

        function addCost() {
            const cantiereId = document.getElementById('cost-cantiere-id').value;
            const date = document.getElementById('cost-date').value;
            const type = document.getElementById('cost-type').value;
            const amount = parseFloat(document.getElementById('cost-amount').value);
            const category = document.getElementById('cost-category').value;
            const description = document.getElementById('cost-description').value;
            
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere) return;
            
            if (!cantiere.costs) {
                cantiere.costs = [];
            }
            
            cantiere.costs.push({
                date,
                type,
                amount,
                category,
                description
            });
            
            saveData();
            updateCostsTable(cantiere);
            document.getElementById('cost-form').reset();
            
            // Aggiorna il grafico
            updateDetailChart(cantiere);
        }

        function deleteCost(cantiereId, costIndex) {
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere || !cantiere.costs) return;
            
            if (confirm('Sei sicuro di voler eliminare questo costo?')) {
                cantiere.costs.splice(costIndex, 1);
                saveData();
                updateCostsTable(cantiere);
                
                // Aggiorna il grafico
                updateDetailChart(cantiere);
            }
        }

        function addMaterial() {
            const cantiereId = document.getElementById('material-cantiere-id').value;
            const date = document.getElementById('material-date').value;
            const name = document.getElementById('material-name').value;
            const quantity = parseFloat(document.getElementById('material-quantity').value);
            const unit = document.getElementById('material-unit').value;
            const unitCost = parseFloat(document.getElementById('material-unit-cost').value);
            const supplier = document.getElementById('material-supplier').value;
            const notes = document.getElementById('material-notes').value;
            
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere) return;
            
            if (!cantiere.materials) {
                cantiere.materials = [];
            }
            
            cantiere.materials.push({
                date,
                name,
                quantity,
                unit,
                unitCost,
                supplier,
                notes
            });
            
            saveData();
            updateMaterialsTable(cantiere);
            document.getElementById('material-form').reset();
            
            // Aggiorna il grafico
            updateDetailChart(cantiere);
        }

        function deleteMaterial(cantiereId, materialIndex) {
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere || !cantiere.materials) return;
            
            if (confirm('Sei sicuro di voler eliminare questo materiale?')) {
                cantiere.materials.splice(materialIndex, 1);
                saveData();
                updateMaterialsTable(cantiere);
                
                // Aggiorna il grafico
                updateDetailChart(cantiere);
            }
        }

        function addWorker() {
            const cantiereId = document.getElementById('worker-cantiere-id').value;
            const date = document.getElementById('worker-date').value;
            const name = document.getElementById('worker-name').value;
            const role = document.getElementById('worker-role').value;
            const hours = parseFloat(document.getElementById('worker-hours').value);
            const hourlyCost = parseFloat(document.getElementById('worker-hourly-cost').value);
            const notes = document.getElementById('worker-notes').value;
            
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere) return;
            
            if (!cantiere.workers) {
                cantiere.workers = [];
            }
            
            cantiere.workers.push({
                date,
                name,
                role,
                hours,
                hourlyCost,
                notes
            });
            
            saveData();
            updateWorkersTable(cantiere);
            document.getElementById('worker-form').reset();
            
            // Aggiorna il grafico
            updateDetailChart(cantiere);
        }

        function deleteWorker(cantiereId, workerIndex) {
            const cantiere = appData.cantieri.find(c => c.id === cantiereId);
            if (!cantiere || !cantiere.workers) return;
            
            if (confirm('Sei sicuro di voler eliminare queste ore lavorative?')) {
                cantiere.workers.splice(workerIndex, 1);
                saveData();
                updateWorkersTable(cantiere);
                
                // Aggiorna il grafico
                updateDetailChart(cantiere);
            }
        }

        // Gestione impostazioni
        function loadSettingsForm() {
            const settings = appData.settings;
            
            document.getElementById('company-name').value = settings.companyName;
            document.getElementById('company-address').value = settings.companyAddress;
            document.getElementById('annual-revenue').value = settings.annual
            document.getElementById('annual-revenue').value = settings.annualRevenue;
            document.getElementById('fixed-costs').value = settings.fixedCosts;
            document.getElementById('worker-hourly-cost').value = settings.workerHourlyCost;
            document.getElementById('foreman-hourly-cost').value = settings.foremanHourlyCost;
            document.getElementById('material-markup').value = settings.materialMarkup;
            document.getElementById('vat-rate').value = settings.vatRate;
            document.getElementById('company-notes').value = settings.companyNotes || '';
        }

        function saveSettings() {
            appData.settings.companyName = document.getElementById('company-name').value;
            appData.settings.companyAddress = document.getElementById('company-address').value;
            appData.settings.annualRevenue = parseFloat(document.getElementById('annual-revenue').value);
            appData.settings.fixedCosts = parseFloat(document.getElementById('fixed-costs').value);
            appData.settings.workerHourlyCost = parseFloat(document.getElementById('worker-hourly-cost').value);
            appData.settings.foremanHourlyCost = parseFloat(document.getElementById('foreman-hourly-cost').value);
            appData.settings.materialMarkup = parseFloat(document.getElementById('material-markup').value);
            appData.settings.vatRate = parseFloat(document.getElementById('vat-rate').value);
            appData.settings.companyNotes = document.getElementById('company-notes').value;

            saveData();
            alert("Impostazioni salvate con successo!");
        }

        function updateDashboardCounters() {
            const active = appData.cantieri.filter(c => c.status === 'active').length;
            const waiting = appData.cantieri.filter(c => c.status === 'waiting').length;
            const completed = appData.cantieri.filter(c => c.status === 'completed').length;
            const problems = appData.cantieri.filter(c => c.status === 'problems').length;

            document.getElementById('active-sites').textContent = active;
            document.getElementById('waiting-sites').textContent = waiting;
            document.getElementById('completed-sites').textContent = completed;
            document.getElementById('problem-sites').textContent = problems;
        }

        function updateArchive() {
            const tbody = document.querySelector('#archive-table tbody');
            const yearFilter = document.getElementById('archive-year').value;
            const clientFilter = document.getElementById('archive-client').value;
            const statusFilter = document.getElementById('archive-status').value;

            tbody.innerHTML = '';

            let archiveData = appData.archive;

            if (yearFilter !== 'all') {
                archiveData = archiveData.filter(a => new Date(a.startDate).getFullYear().toString() === yearFilter);
            }

            if (clientFilter !== 'all') {
                archiveData = archiveData.filter(a => a.client === clientFilter);
            }

            if (statusFilter !== 'all') {
                archiveData = archiveData.filter(a => a.status === statusFilter);
            }

            if (archiveData.length === 0) {
                const row = document.createElement('tr');
                const cell = document.createElement('td');
                cell.colSpan = 9;
                cell.textContent = 'Nessun cantiere trovato';
                row.appendChild(cell);
                tbody.appendChild(row);
                return;
            }

            archiveData.forEach(cantiere => {
                const row = document.createElement('tr');

                const totalSpent = calculateTotalSpent(cantiere);
                const margin = cantiere.budget - totalSpent;

                row.innerHTML = `
                    <td>${cantiere.name}</td>
                    <td>${cantiere.client}</td>
                    <td>${cantiere.address}, ${cantiere.city}</td>
                    <td>${new Date(cantiere.startDate).getFullYear()}</td>
                    <td>${formatCHF(cantiere.budget)}</td>
                    <td>${formatCHF(totalSpent)}</td>
                    <td>${formatCHF(margin)}</td>
                    <td>${getStatusBadge(cantiere.status)}</td>
                    <td><button class="btn btn-info" title="Visualizza"><i class="fas fa-eye"></i></button></td>
                `;

                tbody.appendChild(row);
            });

            // Popola i filtri dinamicamente (anni e clienti)
            const years = [...new Set(appData.archive.map(a => new Date(a.startDate).getFullYear()))];
            const clients = [...new Set(appData.archive.map(a => a.client))];

            const yearSelect = document.getElementById('archive-year');
            const clientSelect = document.getElementById('archive-client');

            yearSelect.innerHTML = `<option value="all">Tutti</option>` + years.map(y => `<option value="${y}">${y}</option>`).join('');
            clientSelect.innerHTML = `<option value="all">Tutti</option>` + clients.map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function updateStats() {
            // Per brevità, puoi implementare eventuali calcoli qui
            // Se vuoi generare grafici con Chart.js, ricordati di importarlo
        }

        function updateCharts() {
            // Stesso discorso: qui puoi aggiornare grafici dinamicamente
            // usando le sezioni di statistiche, se serve
        }
    </script>

    <!-- Chart.js CDN -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</body>
</html>
